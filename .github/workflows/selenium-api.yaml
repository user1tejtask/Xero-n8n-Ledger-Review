name: Run Selenium Script with Browser Choice

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to send the download back to'
        required: true
        type: string
      error_url:
        description: 'Error notification URL'
        required: false
        type: string
      browser_choice:
        description: 'Browser to use (chrome or firefox)'
        required: false
        type: string
        default: 'chrome'
      selenium_script:
        description: 'Selenium script to execute'
        required: true
        type: string

jobs:
  run-selenium-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    strategy:
      matrix:
        browser: ['chrome', 'firefox']
      max-parallel: 1

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Install browsers based on choice
      - name: Install Chrome (for Chrome runs)
        if: matrix.browser == 'chrome'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version

      - name: Install Firefox (for Firefox runs)
        if: matrix.browser == 'firefox'
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox

      # Step 4: Install required dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium undetected-chromedriver requests webdriver-manager pyotp
          
          # Additional packages for better browser handling
          pip install webdriver-manager[chrome]
          pip install webdriver-manager[firefox]
          pip install cryptography  # Needed for undetected-chromedriver

      # Step 5: Set up environment variables
      - name: Set environment variables
        run: |
          echo "API_URL=${{ github.event.inputs.api_url }}" >> $GITHUB_ENV
          echo "ERROR_URL=${{ github.event.inputs.error_url || '' }}" >> $GITHUB_ENV
          echo "BROWSER=${{ matrix.browser }}" >> $GITHUB_ENV
          echo "GITHUB_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          
          # Set display for headless browsers
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
      # Step 6: Start virtual display for Firefox
      - name: Start X Virtual Frame Buffer (for Firefox)
        if: matrix.browser == 'firefox'
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3

      # Step 7: Write the Selenium script to a file
      - name: Write Selenium Script to File
        run: |
          cat << 'EOF' > selenium_script.py
          ${{ github.event.inputs.selenium_script }}
          EOF
          
          echo "Script written to selenium_script.py"
          echo "Using browser: ${{ matrix.browser }}"

      # Step 8: Run the generated Selenium script
      - name: Run Selenium Script
        id: run_selenium
        timeout-minutes: 30  # Increase timeout for slower runs
        run: |
          echo "Starting Selenium script with ${{ matrix.browser }}..."
          
          # Debug: Show Python and package versions
          python --version
          pip list | grep -E "(selenium|undetected|webdriver|requests|pyotp)"
          
          # Run the script
          python selenium_script.py
          
          if [ $? -eq 0 ]; then
            echo "SCRIPT_SUCCESS=true" >> $GITHUB_ENV
            echo "Selenium script completed successfully"
          else
            echo "SCRIPT_SUCCESS=false" >> $GITHUB_ENV
            echo "Selenium script failed"
            exit 1
          fi

      # Step 9: Upload logs and artifacts on failure
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: selenium-logs-${{ matrix.browser }}
          path: |
            /tmp/xero_downloads_*
            selenium_script.py

      # Step 10: Report success to API
      - name: Report Success
        if: success() && env.SCRIPT_SUCCESS == 'true'
        run: |
          echo "Script completed successfully with ${{ matrix.browser }}"
          # The script already sends files to the API

      # Step 11: Report failure to API
      - name: Report Failure
        if: failure()
        run: |
          echo "Script failed with ${{ matrix.browser }}, sending failure notification..."
          if [ -n "${{ github.event.inputs.error_url }}" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "success": false,
                "message": "Selenium script execution failed with ${{ matrix.browser }}",
                "workflow_run_id": "${{ github.run_id }}",
                "browser": "${{ matrix.browser }}"
              }' \
              "${{ github.event.inputs.error_url }}" || echo "Failed to send error notification"
          fi

  # Optional: Combined success notification job
  notify-completion:
    runs-on: ubuntu-latest
    needs: [run-selenium-script]
    if: always()
    
    steps:
      - name: Overall Status
        run: |
          if ${{ needs.run-selenium-script.result == 'success' }}; then
            echo "All browser tests completed successfully"
          else
            echo "Some browser tests failed"
            exit 1
          fi
