name: Run Selenium Script with Browser Choice

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to send the download back to'
        required: true
        type: string
      error_url:
        description: 'Error notification URL'
        required: false
        type: string
      browser_choice:
        description: 'Browser to use (chrome or firefox)'
        required: false
        type: string
        default: 'chrome'
      selenium_script:
        description: 'Selenium script to execute'
        required: true
        type: string

jobs:
  run-selenium-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    strategy:
      matrix:
        browser: ['chrome']
      max-parallel: 1

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Install Chrome
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version
          echo "Chrome installation complete"

      # Step 4: Install Firefox (optional, kept for future use)
      - name: Install Firefox
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox-esr
          firefox --version || echo "Firefox installed"

      # Step 5: Install required dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium==4.15.0
          pip install undetected-chromedriver==3.5.4
          pip install requests==2.31.0
          pip install webdriver-manager==4.0.1
          pip install pyotp==2.9.0
          pip install cryptography==41.0.7
          
          # Verify installations
          pip list | grep -E "(selenium|undetected|requests|webdriver|pyotp|cryptography)"

      # Step 6: Set up environment variables
      - name: Set environment variables
        run: |
          echo "API_URL=${{ github.event.inputs.api_url }}" >> $GITHUB_ENV
          echo "ERROR_URL=${{ github.event.inputs.error_url || '' }}" >> $GITHUB_ENV
          echo "BROWSER=${{ matrix.browser }}" >> $GITHUB_ENV
          echo "GITHUB_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
          
          # Set display for headless browsers
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
      # Step 7: Start virtual display
      - name: Start X Virtual Frame Buffer
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          sleep 3
          echo "Xvfb started on display :99"

      # Step 8: Write the Selenium script to a file
      - name: Write Selenium Script to File
        run: |
          cat << 'EOF' > selenium_script.py
          ${{ github.event.inputs.selenium_script }}
          EOF
          
          echo "Script written to selenium_script.py"
          echo "Using browser: ${{ matrix.browser }}"
          
          # Create logs directory
          mkdir -p selenium_logs

      # Step 9: Run the generated Selenium script
      - name: Run Selenium Script
        id: run_selenium
        timeout-minutes: 45
        run: |
          echo "=== Starting Selenium script with ${{ matrix.browser }} ==="
          
          # Debug: Show Python and package versions
          echo "Python version:"
          python --version
          
          echo "Installed packages:"
          pip list | grep -E "(selenium|undetected|webdriver|requests|pyotp)"
          
          echo "Chrome version:"
          google-chrome --version || echo "Chrome not found"
          
          echo "Current directory:"
          pwd
          
          echo "Files in workspace:"
          ls -la
          
          # Run the script with output logging
          echo "Running selenium script..."
          python selenium_script.py 2>&1 | tee selenium_logs/output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "SCRIPT_SUCCESS=true" >> $GITHUB_ENV
            echo "✓ Selenium script completed successfully"
          else
            echo "SCRIPT_SUCCESS=false" >> $GITHUB_ENV
            echo "✗ Selenium script failed with exit code: $EXIT_CODE"
            
            # Capture any error logs
            if [ -d "/tmp/xero_downloads_"* ]; then
              cp -r /tmp/xero_downloads_* selenium_logs/ 2>/dev/null || true
            fi
            
            exit $EXIT_CODE
          fi

      # Step 10: Upload logs and artifacts on failure
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-failure-logs-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            selenium_logs/
            selenium_script.py
            /tmp/xero_downloads_* 2>/dev/null || echo "No download directories found"
          retention-days: 7

      # Step 11: Upload logs on success for debugging
      - name: Upload success logs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-success-logs-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            selenium_logs/
          retention-days: 3

      # Step 12: Clean up temporary files
      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -f selenium_script.py 2>/dev/null || true
          rm -rf selenium_logs 2>/dev/null || true
          sudo pkill -f Xvfb 2>/dev/null || true
          echo "Cleanup complete"

  # Optional: Combined success notification job
  notify-completion:
    runs-on: ubuntu-latest
    needs: [run-selenium-script]
    if: always()
    
    steps:
      - name: Check workflow status
        run: |
          echo "Selenium job result: ${{ needs.run-selenium-script.result }}"
          
          if [ "${{ needs.run-selenium-script.result }}" = "success" ]; then
            echo "✓ All browser tests completed successfully"
          else
            echo "✗ Browser tests failed"
            # Don't exit with error to prevent workflow failure cascade
          fi
