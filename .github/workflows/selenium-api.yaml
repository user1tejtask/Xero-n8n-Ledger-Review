name: Run Selenium Script with Browser Choice

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to send the download back to'
        required: true
        type: string
      error_url:
        description: 'Error notification URL'
        required: false
        type: string
      browser_choice:
        description: 'Browser to use (chrome or firefox)'
        required: false
        type: string
        default: 'chrome'
      selenium_script:
        description: 'Selenium script to execute'
        required: true
        type: string

jobs:
  run-selenium-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    strategy:
      matrix:
        browser: ['chrome']
      max-parallel: 1

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Install required Python dependencies FIRST
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium==4.18.1
          pip install undetected-chromedriver==3.5.5
          pip install requests==2.31.0
          pip install webdriver-manager==4.0.1
          pip install pyotp==2.9.0
          pip install cryptography==42.0.5
          
          # Verify installations
          echo "Installed packages:"
          pip list | grep -E "(selenium|undetected|requests|webdriver|pyotp|cryptography)"

      # Step 4: Install Chrome
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg software-properties-common
          
          # Install Chrome
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          echo "Chrome version:"
          google-chrome --version
          echo "✓ Chrome installation complete"

      # Step 5: Install Firefox (optional, for future use)
      - name: Install Firefox
        run: |
          sudo apt-get update
          # Install Firefox from Ubuntu repositories
          sudo apt-get install -y firefox
          
          echo "Firefox version:"
          firefox --version || firefox-esr --version || echo "Firefox version check failed"
          echo "✓ Firefox installation attempted"

      # Step 6: Install GeckoDriver (simpler direct approach)
      - name: Install GeckoDriver
        run: |
          # Install GeckoDriver directly (no Python module dependency here)
          GECKODRIVER_VERSION="0.34.0"
          echo "Installing GeckoDriver v${GECKODRIVER_VERSION}"
          
          wget -q "https://github.com/mozilla/geckodriver/releases/download/v${GECKODRIVER_VERSION}/geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz"
          
          if [ -f "geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz" ]; then
            tar -xzf geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz
            sudo mv geckodriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/geckodriver
            rm geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz
            
            echo "GeckoDriver installed at: /usr/local/bin/geckodriver"
            geckodriver --version || echo "GeckoDriver version check failed"
            echo "✓ GeckoDriver installation complete"
          else
            echo "Warning: Failed to download GeckoDriver"
            echo "Will rely on webdriver-manager in Python script"
          fi

      # Step 7: Set up environment variables
      - name: Set environment variables
        run: |
          echo "API_URL=${{ github.event.inputs.api_url }}" >> $GITHUB_ENV
          echo "ERROR_URL=${{ github.event.inputs.error_url || '' }}" >> $GITHUB_ENV
          echo "BROWSER=${{ matrix.browser }}" >> $GITHUB_ENV
          echo "GITHUB_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV

      # Step 8: Install Xvfb for headless display
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils
          echo "✓ Xvfb installed"

      # Step 9: Start virtual display
      - name: Start X Virtual Frame Buffer
        run: |
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          sleep 3
          echo "Xvfb started on display :99"
          echo "DISPLAY=:99" >> $GITHUB_ENV

      # Step 10: Write the Selenium script to a file
      - name: Write Selenium Script to File
        run: |
          cat << 'EOF' > selenium_script.py
          ${{ github.event.inputs.selenium_script }}
          EOF
          
          echo "Script written to selenium_script.py"
          echo "Using browser: ${{ matrix.browser }}"
          
          # Create logs directory
          mkdir -p selenium_logs

      # Step 11: Run the generated Selenium script
      - name: Run Selenium Script
        id: run_selenium
        timeout-minutes: 45
        env:
          DISPLAY: :99
        run: |
          echo "=== Starting Selenium script with ${{ matrix.browser }} ==="
          
          # Debug: Show installed components
          echo "Python version:"
          python --version
          
          echo "Installed Python packages:"
          pip list | grep -E "(selenium|undetected|requests|webdriver|pyotp)"
          
          echo "Chrome version:"
          google-chrome --version || echo "Chrome not found"
          
          echo "Firefox version (if installed):"
          firefox --version 2>/dev/null || echo "Firefox not found"
          
          echo "GeckoDriver version (if installed):"
          geckodriver --version 2>/dev/null || echo "GeckoDriver not found"
          
          # Check if Python script is valid
          echo "Checking Python script syntax..."
          python -m py_compile selenium_script.py && echo "✓ Python script syntax is valid"
          
          # Run the script with output logging
          echo "Running selenium script..."
          
          # Run with error handling
          set +e  # Don't exit immediately on error
          python selenium_script.py 2>&1 | tee selenium_logs/output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "SCRIPT_SUCCESS=true" >> $GITHUB_ENV
            echo "✓ Selenium script completed successfully"
          else
            echo "SCRIPT_SUCCESS=false" >> $GITHUB_ENV
            echo "✗ Selenium script failed with exit code: $EXIT_CODE"
            
            # Capture any error logs
            if [ -d "/tmp/xero_downloads_"* ]; then
              cp -r /tmp/xero_downloads_* selenium_logs/ 2>/dev/null || true
            fi
            
            exit $EXIT_CODE
          fi

      # Step 12: Upload logs and artifacts on failure
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-failure-logs-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            selenium_logs/
            selenium_script.py
          retention-days: 7

      # Step 13: Upload logs on success for debugging
      - name: Upload success logs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-success-logs-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            selenium_logs/
          retention-days: 3

      # Step 14: Clean up temporary files
      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -f selenium_script.py 2>/dev/null || true
          rm -rf selenium_logs 2>/dev/null || true
          sudo pkill -f Xvfb 2>/dev/null || true
          echo "Cleanup complete"

  # Optional: Combined success notification job
  notify-completion:
    runs-on: ubuntu-latest
    needs: [run-selenium-script]
    if: always()
    
    steps:
      - name: Check workflow status
        run: |
          echo "Selenium job result: ${{ needs.run-selenium-script.result }}"
          
          if [ "${{ needs.run-selenium-script.result }}" = "success" ]; then
            echo "✓ All browser tests completed successfully"
          else
            echo "✗ Browser tests failed"
          fi
