name: Run Selenium Script from API Request

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to send the download back to'
        required: true
        type: string
      selenium_script:
        description: 'Selenium script to execute'
        required: true
        type: string

jobs:
  run-selenium-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Step 3: Install Chrome browser
      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # Step 4: Install required dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium undetected-chromedriver requests webdriver-manager pyotp

      # Step 5: Set up environment variables
      - name: Set environment variables
        run: |
          echo "API_URL=${{ github.event.inputs.api_url }}" >> $GITHUB_ENV
          echo "GITHUB_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          
      # Step 6: Write the Selenium script to a file
      - name: Write Selenium Script to File
        run: |
          cat << 'EOF' > selenium_script.py
          ${{ github.event.inputs.selenium_script }}
          EOF

      # Step 7: Run the generated Selenium script
      - name: Run Selenium Script
        id: run_selenium
        run: |
          echo "Starting Selenium script execution..."
          python selenium_script.py
          echo "SCRIPT_SUCCESS=true" >> $GITHUB_ENV

      # Step 8: Report success to API (if script didn't already)
      - name: Report Success
        if: success() && env.SCRIPT_SUCCESS == 'true'
        run: |
          echo "Script completed successfully"
          # The script already sends files to the API, so we just log success here

      # Step 9: Report failure to API
      - name: Report Failure
        if: failure()
        run: |
          echo "Script failed, sending failure notification to API..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "success": false,
              "message": "Selenium script execution failed",
              "workflow_run_id": "${{ github.run_id }}"
            }' \
            ${{ github.event.inputs.api_url }} || echo "Failed to send error notification"