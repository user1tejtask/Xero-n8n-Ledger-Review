name: Run Selenium Script from API Request

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to send the download back to'
        required: true
        type: string
      selenium_script:
        description: 'Selenium script to execute'
        required: true
        type: string

jobs:
  run-selenium-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Setup Tor Proxy
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
          sudo service tor start
          sleep 3
          echo "PROXY_SERVER=socks5://localhost:9050" >> $GITHUB_ENV

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install selenium undetected-chromedriver requests webdriver-manager pyotp pysocks

      - name: Set environment variables
        run: |
          echo "API_URL=${{ github.event.inputs.api_url }}" >> $GITHUB_ENV
          echo "GITHUB_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV

      - name: Write Selenium Script
        run: |
          cat << 'EOF' > selenium_script.py
          ${{ github.event.inputs.selenium_script }}
          EOF

      - name: Run Selenium Script
        id: run_selenium
        env:
          PROXY_SERVER: ${{ env.PROXY_SERVER }}
        run: |
          echo "Starting Selenium script execution..."
          echo "Proxy: ${PROXY_SERVER:-No proxy}"
          python selenium_script.py
          echo "SCRIPT_SUCCESS=true" >> $GITHUB_ENV

      - name: Report Success
        if: success() && env.SCRIPT_SUCCESS == 'true'
        run: echo "Script completed successfully"

      - name: Report Failure
        if: failure()
        run: |
          echo "Script failed"
          curl -X POST "${{ github.event.inputs.api_url }}" \
            -H "Content-Type: application/json" \
            -d '{"success": false, "message": "Selenium script failed", "run_id": "${{ github.run_id }}"}' \
            --max-time 10 || true

